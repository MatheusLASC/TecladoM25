<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Babylon.js sample code</title>

    <!-- Babylon.js -->
    <script src="https://code.jquery.com/pep/0.4.2/pep.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/ammo.js"></script>
    <script src="https://preview.babylonjs.com/cannon.js"></script>
    <script src="https://preview.babylonjs.com/Oimo.js"></script>
    <script src="https://preview.babylonjs.com/earcut.min.js"></script>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
    <script src="https://preview.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
    <script src="https://preview.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.js"></script>
    <script src="https://preview.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://preview.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>

<body>
    <canvas id="renderCanvas"></canvas>
    <script>

        var canvas = document.getElementById("renderCanvas");

        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function () { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true, disableWebGL2Support: false }); };
        var scene;
        var notes = new Map();
        var i,j,x,t,parte;
        var count=-6;
        

        var createScene = function () {
            scene = new BABYLON.Scene(engine);

            /**** Set camera and light *****/
            const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 2.5, 10, new BABYLON.Vector3(0, 0, -3.5));
            camera.attachControl(canvas, true);
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(1, 1, 0));
            
            managerEvents();
            musicas();
            modelagemExterna();
            createTom();
            createSemiTom();
            

            return scene;

        };

        function managerEvents() {

            scene.onPointerDown = function (evt, pickResults) {
                if (pickResults.hit) {
                    notes.get(pickResults.pickedMesh.name).play();
                    
                }
            }

        }

        function musicas() {

        	scene.onKeyboardObservable.add((kbInfo) => {
		switch (kbInfo.type) {
			case BABYLON.KeyboardEventTypes.KEYDOWN:
				switch (kbInfo.event.key) {
                    case "p":
                    case "P":
                    Beethoven();
                    break;
                }
			break;
		}
	});
        }

        async function Beethoven()
        {
        //Parte com tocada com a Mão Direita Completa de Beethoven
        //Aula para referência: https://www.youtube.com/watch?v=3Y88hwdqU9U
            for(parte=0;parte<4;parte++)
            {
                    if(parte ==0 || parte == 1 || parte == 3)
                    {
                        //Parte 1
                    for(x=0;x<2;x++)
                        {
                            notes.get(9).play();
                            await new Promise(p => setTimeout(p, 300));
                            notes.get(21).play();
                            await new Promise(p => setTimeout(p, 300));
                        }
                        console.log("Parte 1 - 1");
                    }
                    
                    
                        notes.get(9).play();
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(6).play();
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(8).play();
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(7).play();
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(5).play();
                        await new Promise(p => setTimeout(p, 300));
                        console.log("Parte 1 - 2");
                        //Parte 2
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(0).play();
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(2).play();
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(5).play();
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(6).play();
                        await new Promise(p => setTimeout(p, 300));
                        console.log("Parte 2");

                        if(parte == 0 || parte ==2)
                        {
                            //Parte 3
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(2).play();
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(18).play();
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(6).play();
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(7).play();
                        await new Promise(p => setTimeout(p, 300));
                        console.log("Parte 3");
                        }
                        if(parte ==1 || parte == 3)
                        {
                            //Parte 4 
                            await new Promise(p => setTimeout(p, 300));
                            notes.get(2).play();
                            await new Promise(p => setTimeout(p, 300));
                            notes.get(7).play();
                            await new Promise(p => setTimeout(p, 300));
                            notes.get(6).play();
                            await new Promise(p => setTimeout(p, 300));
                            notes.get(5).play();
                            await new Promise(p => setTimeout(p, 300));
                            console.log("Parte 4");
                        if(parte == 1)
                            {
                                //Parte 5
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(6).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(7).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(8).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(9).play();
                                await new Promise(p => setTimeout(p, 300));

                                notes.get(4).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(10).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(9).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(8).play();
                                await new Promise(p => setTimeout(p, 300));

                                notes.get(3).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(9).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(8).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(7).play();
                                await new Promise(p => setTimeout(p, 300));

                                notes.get(2).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(8).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(7).play();
                                await new Promise(p => setTimeout(p, 300));
                                notes.get(6).play();
                                await new Promise(p => setTimeout(p, 300));

                                for(x=0;x<2;x++)
                                {
                                    notes.get(2).play();
                                    await new Promise(p => setTimeout(p, 300));
                                }
                                    notes.get(9).play();
                                    await new Promise(p => setTimeout(p, 300));
                                    notes.get(2).play();
                                    await new Promise(p => setTimeout(p, 300));

                                    for(x=0;x<2;x++)
                                {
                                    notes.get(9).play();
                                    await new Promise(p => setTimeout(p, 300));
                                }
                                
                                // nota extendida que quis adicionar pois não cabia no teclado
                                // não aparece visualmente
                                var Mi5 = new BABYLON.Sound("Mi", "/assets/E5.mp3", scene);
                                Mi5.play();
                                await new Promise(p => setTimeout(p, 300));

                                await new Promise(p => setTimeout(p, 300));
                                for(x=0; x<2; x++)
                                {
                                    notes.get(21).play();
                                    await new Promise(p => setTimeout(p, 300));
                                    notes.get(9).play();
                                    await new Promise(p => setTimeout(p, 300));
                                }
                                await new Promise(p => setTimeout(p, 300));
                                console.log("Parte 5");
                                
                            }
                        }
                        
                        if(parte == 0 || parte ==2)
                        {
                            //Nota de passagem
                        await new Promise(p => setTimeout(p, 300));
                        notes.get(2).play();
                        await new Promise(p => setTimeout(p, 300));
                        console.log("Nota de Passagem");
                        }
                        
            
            }

                            
        }


        function modelagemExterna()
        {
            const tecladoMat = new BABYLON.StandardMaterial("tecladoMat");
            tecladoMat.diffuseTexture = new BABYLON.Texture("/assets/teclado.webp");
            var modelagem = [], modelagem2 = [];
            
             modelagem[0] = new BABYLON.Vector4(0.078125, 0.46875, 0.75, 0.5);
             modelagem[1] = new BABYLON.Vector4(0.078125, 0.46875, 0.921875, 0.9375);
             modelagem[2] = new BABYLON.Vector4(0.078125, 0.46875, 0.75, 0.5);
             modelagem[3] = new BABYLON.Vector4(0.078125, 0.46875, 0.75, 0.5);
             modelagem[4] = new BABYLON.Vector4(0.078125, 0.46875, 0.75, 0.5);
             modelagem[5] = new BABYLON.Vector4(0.078125, 0.46875, 0.75, 0.5);

            var topo = BABYLON.MeshBuilder.CreateBox("topo", {height: 3, width: 16, faceUV: modelagem});
            topo.position.x = 1;
            topo.position.y = 2.5;
            topo.material = tecladoMat;

            for(x=0; x<6;x++)
                {
                    modelagem2[x] = new BABYLON.Vector4(0.078125, 0.25, 0.078125, 0.5);
                }
                
            var lateral = BABYLON.MeshBuilder.CreateBox("lateral", {height: 6, width: 0.5, faceUV: modelagem2});
            lateral.position.x = -6.75;
            lateral.position.y = -2;
            lateral.material = tecladoMat;

           var lateraloposta = lateral.clone("lateraloposta");
           lateraloposta.position.x = 8.75;
           lateraloposta.position.y = -2;

            var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("myUI");
            var mensagem = BABYLON.GUI.Button.CreateSimpleButton("button", "Modo Demo - Aperte a Tecla 'P'");
            mensagem.width = 0.2
            mensagem.top = 250;
            mensagem.left = 50;
            mensagem.height = "40px"
            mensagem.color = "white"
            mensagem.background = "Blue"

            advancedTexture.addControl(mensagem);

        }

        function createTom()
        {
            for(i=0; i<15; i++)
            {

                switch (i) {
                case 0:
                //Do 
                noteTom = new Note(i, "/assets/C3.mp3",0);
                break;
                case 1:
                //Ré
                noteTom = new Note(i, "/assets/D3.mp3",0);
                break;
                case 2:
                //Mi
                noteTom = new Note(i, "/assets/E3.mp3",0);
                break;
                case 3:
                //Fá
                noteTom = new Note(i, "/assets/F3.mp3",0);
                break;
                case 4:
                //Sol
                noteTom = new Note(i, "/assets/G3.mp3",0);
                break;
                case 5:
                //Lá
                noteTom = new Note(i, "/assets/A3.mp3",0);
                break;
                case 6:
                //Si
                noteTom = new Note(i, "/assets/B3.mp3",0);
                break;
                case 7:
                //Do Oitavado
                noteTom = new Note(i, "/assets/C4.mp3",0);
                break;
                case 8:
                //Ré Oitavado
                noteTom = new Note(i, "/assets/D4.mp3",0);
                break;
                case 9:
                //Mi Oitavado
                noteTom = new Note(i, "/assets/E4.mp3",0);
                break;
                case 10:
                //Fá Oitavado
                noteTom = new Note(i, "/assets/F4.mp3",0);
                break;
                case 11:
                //Sol Oitavado
                noteTom = new Note(i, "/assets/G4.mp3",0);
                break;
                case 12:
                //Lá Oitavado
                noteTom = new Note(i, "/assets/A4.mp3",0);
                break;
                case 13:
                //Si Oitavado
                noteTom = new Note(i, "/assets/B4.mp3",0);
                break;
                case 14:
                //Do 2 oitavas acima
                noteTom = new Note(i, "/assets/C5.mp3",0);
                break;

                default:
                console.log(`Nota inexistente`);
                }
                noteTom.box.position.y = -2;
                noteTom.box.position.x = count;
                count++;
                notes.set(i,noteTom);

            }
           
        }

        function createSemiTom()
        {
            count = -5.5;
        
           for(i=15; i<25; i++)
            {

                switch (i) {
                case 15:
                //Ré b
                noteTom = new Note(i, "/assets/Db3.mp3",1);
                break;
                case 16:
                //Mi b
                noteTom = new Note(i, "/assets/Eb3.mp3",1);
                break;
                case 17:
                //Sol b
                noteTom = new Note(i, "/assets/Gb3.mp3",1);
                break;
                case 18:
                //Lá b
                noteTom = new Note(i, "/assets/Ab3.mp3",1);
                break;
                case 19:
                //Si b
                noteTom = new Note(i, "/assets/Bb3.mp3",1);
                break;
                case 20:
                //Ré b oitavado
                noteTom = new Note(i, "/assets/Db4.mp3",1);
                break;
                case 21:
                //Mi b oitavado
                noteTom = new Note(i, "/assets/Eb4.mp3",1);
                break;
                case 22:
                //Sol b oitavado
                noteTom = new Note(i, "/assets/Gb4.mp3",1);
                break;
                case 23:
                //Lá b oitavado
                noteTom = new Note(i, "/assets/Ab4.mp3",1);
                break;
                case 24:
                //Si b oitavado
                noteTom = new Note(i, "/assets/Bb4.mp3",1);
                break;
                

                default:
                console.log(`Nota inexistente`);
                }
                noteTom.box.position.y = -1;
                noteTom.box.position.z = -0.5;
                noteTom.box.position.x = count;

                if(i == 16 || i == 19 || i== 21)
                {
                    count++;
                }
                count++;
                notes.set(i,noteTom);

  
            }

        }

        initFunction = async function () {
            var asyncEngineCreation = async function () {
                try {
                    return createDefaultEngine();
                } catch (e) {
                    console.log("the available createEngine function failed. Creating the default engine instead");
                    return createDefaultEngine();
                }
            }

            engine = await asyncEngineCreation();
            if (!engine) throw 'engine should not be null.';
            scene = createScene();
        };
        initFunction().then(() => {
            sceneToRender = scene
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    sceneToRender.render();
                }
            });
        });

        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });


        class Note {
            constructor(noteName, noteUrl, type) {
                this.rSlide = new BABYLON.Animation("rSlide", "position.z", 100, BABYLON.Animation.ANIMATIONTYPE_FLOAT, BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
                let keyFrames = [];
                
                if(type == 0)
                {
                    keyFrames.push({
                    frame: 0,
                    value: 0.5
                    });

                    keyFrames.push({
                    frame: 5,
                    value: 0.0
                    });

                }
                

                else if(type == 1)
                {
                    keyFrames.push({
                    frame: 0,
                    value: 0
                    });

                    keyFrames.push({
                    frame: 5,
                    value: -0.5
                    });

                }

                const teclasMat = new BABYLON.StandardMaterial("teclasMat");
                teclasMat.diffuseTexture = new BABYLON.Texture("/assets/teclas.png");
   
                this.rSlide.setKeys(keyFrames);
                
                var tamanho,largura,faceUV = [];
                // Load the sound, give it time to load and play it every 3 seconds
                this.note = new BABYLON.Sound(noteName, noteUrl, scene);
                if(type == 0)
                {
                    tamanho = 6;
                    largura = 1;
                    
                    for(j=0; j<6;j++)
                    {
                        faceUV[j] = new BABYLON.Vector4(0.9375, 0.0, 1, 1);
                    }
                 
                }
                else if(type == 1)
                {
                    tamanho = 4;
                    largura = 0.5;

                    
                    for(j=0; j<6;j++)
                    {
                        faceUV[j] = new BABYLON.Vector4(0.125, 0.5, 0.125, 1);
                    }
                 
                }

 
                //modelar cor das teclas
                //aplicar efeito de particula
                this.box = BABYLON.MeshBuilder.CreateBox(noteName, {height: tamanho, width: largura, faceUV: faceUV});
                this.box.material = teclasMat;
            }

            play() {
                this.note.play();
                scene.beginDirectAnimation(this.box, [this.rSlide], 0, 5, true);
            }
        }
    </script>
</body>

</html>